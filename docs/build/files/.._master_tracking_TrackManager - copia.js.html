<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..\master\tracking\TrackManager - copia.js - The Foo API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title="The Foo API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.2.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Metadata.html">Metadata</a></li>
            
                <li><a href="..&#x2F;classes/Playhead.html">Playhead</a></li>
            
                <li><a href="..&#x2F;classes/Timeline.html">Timeline</a></li>
            
                <li><a href="..&#x2F;classes/Timer.html">Timer</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/Node.html">Node</a></li>
            
                <li><a href="..&#x2F;modules/smx.html">smx</a></li>
            
                <li><a href="..&#x2F;modules/SMXComputedAttributes.html">SMXComputedAttributes</a></li>
            
                <li><a href="..&#x2F;modules/SMXCoreAttributes.html">SMXCoreAttributes</a></li>
            
                <li><a href="..&#x2F;modules/SMXNode.html">SMXNode</a></li>
            
                <li><a href="..&#x2F;modules/TimeAttrController
Plugin Controller for attributes namespace with &#x27;ui&#x27;.html">TimeAttrController
Plugin Controller for attributes namespace with &#x27;ui&#x27;</a></li>
            
                <li><a href="..&#x2F;modules/Track Attributes.html">Track Attributes</a></li>
            
                <li><a href="..&#x2F;modules/UIAttrController
Plugin Controller for attributes namespaced with &#x27;ui-&#x27;.html">UIAttrController
Plugin Controller for attributes namespaced with &#x27;ui-&#x27;</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ..\master\tracking\TrackManager - copia.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function(smx){


	var TrackManager = function(doc){

		&#x2F;&#x2F;document &amp;&amp; playhead params are required
		if(!doc) return;

		&#x2F;&#x2F;extend with Backbone Events
		_.extend(this, Backbone.Events);

		&#x2F;&#x2F;set document
		this.document = doc;

		&#x2F;&#x2F;set playhead
		this.playhead = this.document.playhead;

		this.collection = new Backbone.Collection();

		this.attrControllers = smx.tracking.TrackDataTypes;

		this.initializeDocument();

		return this;

	};

	TrackManager.prototype.initializeDocument = function(){

		&#x2F;&#x2F;get the nodes that will have a track
		&#x2F;&#x2F;actually whole document content nodes
		var nodes = this.document.find(&#x27;*&#x27;);
		
		&#x2F;&#x2F;add document node itself to list
		nodes.unshift(this.document);

		&#x2F;&#x2F; create a track for each node
		for (var n=0; n&lt;nodes.length; n++){

			var node = nodes[n];

			var is_tracking = node.isTracking();

			if (is_tracking){

				var attrs = node[0].attributes;

				&#x2F;&#x2F;create empty object for tracking attributes
				var track_attrs = {};

				&#x2F;&#x2F;add node id
				track_attrs.id = node.id;

				&#x2F;&#x2F;add all attributes which names start with &#x27;track-&#x27; 
				for(var i = 0; i &lt; attrs.length; i++) {
					var attr_name = attrs[i].name;
					var attr_value = attrs[i].value;
					if(attr_name.indexOf(&quot;track-&quot;) == 0){
						attr_name = attr_name.substr(6);
						track_attrs[attr_name] = attr_value;
					}
						
				}

				if (node.parent()) track_attrs.parent = node.parent().id;

				&#x2F;&#x2F;create a new Track with catched attributes
				var track = new smx.tracking.Track(track_attrs);

				&#x2F;&#x2F;add just created to track to collection
				this.collection.add(track);


			}


		}


		&#x2F;&#x2F;set collection changes observer
		this.collection.on(&#x27;change&#x27;,_.bind(this.onCollectionChange,this));

		&#x2F;&#x2F;set playhead observers
		this.playhead.on(&#x27;enter&#x27;,_.bind(this.onNodeEnter,this));
		this.playhead.on(&#x27;exit&#x27;,_.bind(this.onNodeExit,this));

		&#x2F;&#x2F;set timeline observers
		this.playhead.on(&#x27;timeline:enter&#x27;,_.bind(this.onNodeEnter,this));
		this.playhead.on(&#x27;timeline:exit&#x27;,_.bind(this.onNodeExit,this));
		this.playhead.on(&#x27;timeline:play&#x27;,_.bind(this.onTimelinePlay,this));
		this.playhead.on(&#x27;timeline:pause&#x27;,_.bind(this.onTimelinePause,this));
		this.playhead.on(&#x27;timeline:update&#x27;,_.bind(this.onTimelineUpdate,this));


		return this;

	};



	&#x2F;**
	 *	Get raw value for specified node id and attribute key
	 *	Uses SMXNode &#x27;raw&#x27; method
	 *
     *  @method raw
     *  @param id {string} node id
     *  @param key {string} attribute key
     *  @return {string} resulting value or null
     *
  	 *&#x2F;

	TrackManager.prototype.raw = function(id, key){

		&#x2F;&#x2F;if bad params return undefined
		if (!id || !key) return;

		&#x2F;&#x2F;get node by id
		var node = this.document.getNodeById(id);

		&#x2F;&#x2F;if not found node return undefined
		if (!node) return;

		&#x2F;&#x2F;return value or undefined
		return node.raw(&#x27;track-&#x27;+ key);

	};


	&#x2F;**
	 *	Answer this question:
	 *	Has key attribute the node with give id?
	 *
     *  @method has
     *  @param id {String} node id
     *  @param key {String} attribute key
     *  @return {Boolean} has or not the specified key
     *
  	 *&#x2F;

	TrackManager.prototype.has = function(id, key){

		&#x2F;&#x2F;if bad params return false
		if (!id || !key) return false;

		&#x2F;&#x2F;get node by id
		var node = this.document.getNodeById(id);

		&#x2F;&#x2F;if not found node return false
		if (!node) return false;

		&#x2F;&#x2F;get raw value by key
		var value = node.raw(&#x27;track-&#x27;+ key);

		&#x2F;&#x2F;raw will always return String or null value
		return (_.isString(value))? true : false;

	};


	TrackManager.prototype.get = function(id, key, format){

		&#x2F;&#x2F;if bad params return undefined
		if (!id || !key) return;

		&#x2F;&#x2F;get track by id
		var track = this.collection.get(id);

		&#x2F;&#x2F;if not found track return undefined
		if (!track) return;

		&#x2F;&#x2F;if track has no key attr return undefined
		if (!this.has(id,key)) return;

		&#x2F;&#x2F;get attr controller
		var attrController = this.attrControllers[key];

		&#x2F;&#x2F;get value
		var value;

		&#x2F;&#x2F;if exists attr controller and has get method use it
		&#x2F;&#x2F;else use default get method
		if(attrController &amp;&amp; attrController.get) 	value = attrController.get(track, this, format);
		else 										value = track.get(key);

		&#x2F;&#x2F;return resultant value
		return value;

	};

	TrackManager.prototype.set = function(id, key, value){

		&#x2F;&#x2F;if bad params exit
		if (!id || !key || typeof value == &#x27;undefined&#x27;) return;

		&#x2F;&#x2F;get track by id
		var track = this.collection.get(id);

		&#x2F;&#x2F;if not found track exit
		if (!track) return;

		&#x2F;&#x2F;if track has no key attr exit
		if (!this.has(id,key)) return;

		&#x2F;&#x2F;get attr controller
		var attrController = this.attrControllers[key];

		&#x2F;&#x2F;if exists attr controller and has set method use it
		&#x2F;&#x2F;else use default set method
		if(attrController &amp;&amp; attrController.set)	return attrController.set(value, track, this);
		else										return track.set(key, value);

	};



	TrackManager.prototype.refresh = function(id, key){

		if (!id || !key) return;

		var track = this.collection.get(id);

		if (!track) return;

		var handler = this.attrControllers[key];

		if(!handler || !handler.refresh) return;

		return handler.refresh(track, this);

	};




	TrackManager.prototype.onCollectionChange = function(track){

		if(track.changed){

			var previous = track.previousAttributes();

			var keys = _.keys(track.changed);

			for (var i=0; i&lt; keys.length; i++){

				var previous_value = track.changed[keys[i]];

				&#x2F;&#x2F;log it
				&#x2F;&#x2F;console.log(&#x27;#&#x27;+track.id + &#x27;@&#x27;+keys[i]+&#x27;: &#x27;+ previous_value +&#x27; -&gt; &#x27;+ track.get(keys[i]));

				&#x2F;&#x2F;call bubblers
				var handler = this.attrControllers[keys[i]];
				if(handler.propagate){
					handler.propagate(track, this, previous[keys[i]],previous_value);
				}				

			}

			for (var i=0; i&lt; keys.length; i++){

				&#x2F;&#x2F;fire event &#x27;change:trackId:keyId&#x27;
				var strEvent = &#x27;change:&#x27;+ track.id +&#x27;:&#x27;+keys[i];
				this.trigger(strEvent,track);


			}

		}

		return;

	};



    &#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;
    &#x2F;&#x2F; PLAYHEAD EVENT HANDLERS

	TrackManager.prototype.onNodeEnter = function(event){

		&#x2F;&#x2F;this is handler for 2 events
		&#x2F;&#x2F;1 - timeline event, recives event object
		&#x2F;&#x2F;2- playhead event, node

		var node = (event.target)? event.target : event;

		&#x2F;&#x2F;get track by node.id
		var track = this.collection.get(node.id);

		&#x2F;&#x2F;valid track is required
		if(!track) return;


		var keys = _.keys(this.attrControllers);

		for (var i=0;i&lt;keys.length;i++){
			if(this.attrControllers[keys[i]].onenter) this.attrControllers[keys[i]].onenter(track,this,event);
		}


		return;

	};

	TrackManager.prototype.onNodeExit = function(event){

		&#x2F;&#x2F;this is handler for 2 events
		&#x2F;&#x2F;1 - timeline event, recives event object
		&#x2F;&#x2F;2- playhead event, node

		var node = (event.target)? event.target : event;

		&#x2F;&#x2F;get track by node.id
		var track = this.collection.get(node.id);

		&#x2F;&#x2F;valid track is required
		if(!track) return;


		var keys = _.keys(this.attrControllers);

		for (var i=0;i&lt;keys.length;i++){
			if(this.attrControllers[keys[i]].onexit) this.attrControllers[keys[i]].onexit(track,this,event);
		}


		return;

	};

	TrackManager.prototype.onTimelinePlay = function(event){

		&#x2F;&#x2F;this is handler for 2 events
		&#x2F;&#x2F;1 - timeline event, recives event object
		&#x2F;&#x2F;2- playhead event, node

		var node = (event.target)? event.target : event;

		&#x2F;&#x2F;get track by node.id
		var track = this.collection.get(node.id);

		&#x2F;&#x2F;valid track is required
		if(!track) return;


		var keys = _.keys(this.attrControllers);

		for (var i=0;i&lt;keys.length;i++){
			if(this.attrControllers[keys[i]].onplay) this.attrControllers[keys[i]].onplay(track,this,event);
		}


		return;

	};

	TrackManager.prototype.onTimelinePause = function(event){

		&#x2F;&#x2F;this is handler for 2 events
		&#x2F;&#x2F;1 - timeline event, recives event object
		&#x2F;&#x2F;2- playhead event, node

		var node = (event.target)? event.target : event;

		&#x2F;&#x2F;get track by node.id
		var track = this.collection.get(node.id);

		&#x2F;&#x2F;valid track is required
		if(!track) return;


		var keys = _.keys(this.attrControllers);

		for (var i=0;i&lt;keys.length;i++){
			if(this.attrControllers[keys[i]].onpause) this.attrControllers[keys[i]].onpause(track,this,event);
		}


		return;

	};


	TrackManager.prototype.onTimelineUpdate = function(event){

		&#x2F;&#x2F;this is handler for 2 events
		&#x2F;&#x2F;1 - timeline update event, recives event object
		&#x2F;&#x2F;2 - playhead update event, node

		var node = (event.target)? event.target : event;

		&#x2F;&#x2F;get track by node.id
		var track = this.collection.get(node.id);

		&#x2F;&#x2F;valid track is required
		if(!track) return;


		var keys = _.keys(this.attrControllers);

		for (var i=0;i&lt;keys.length;i++){
			if(this.attrControllers[keys[i]].onupdate) this.attrControllers[keys[i]].onupdate(track,this,event);
		}


		return;

	};





	&#x2F;*
		JSON IO API

	*&#x2F;

	TrackManager.prototype.toJSON = function (options){
		
		var defaults = {
			&#x27;format&#x27;:&#x27;json&#x27;, &#x2F;&#x2F; output format [&#x27;json&#x27;|&#x27;text&#x27;]
			&#x27;onlychanged&#x27;: false	&#x2F;&#x2F; if true will only return changed attributes
		}

		options = _.extend(defaults,options);

		var myJSON = [];

		var _this = this;
		this.collection.each(function(item,index){

			var node = _this.document.getNodeById(item.id);

			var isTracking = node.isTracking();

			var obj = {};


			obj.id = item.id;


			&#x2F;&#x2F;ACCESS
			var access_raw = _this.get(item.id, &quot;access&quot;, &#x27;raw&#x27;);
			var access = _this.get(item.id, &quot;access&quot;);

			if (!options.onlychanged) obj[&quot;access&quot;] = access;
			else
				if(!_.isUndefined(access_raw) &amp;&amp; access_raw!=&#x27;none&#x27; &amp;&amp; access_raw!=&#x27;auto&#x27;)
					if(access&gt;0 &amp;&amp; access!=access_raw)
						obj[&quot;access&quot;] = access;			


			&#x2F;&#x2F;VIEWS
			var views_raw = _this.get(item.id, &quot;views&quot;, &#x27;raw&#x27;);
			var views = _this.get(item.id, &quot;views&quot;);

			if (!options.onlychanged) obj[&quot;views&quot;] = views;
			else
				if(!_.isUndefined(views_raw) &amp;&amp; views_raw!=&#x27;none&#x27;)
					if(views&gt;0 &amp;&amp; views!=views_raw)
						obj[&quot;views&quot;] = views;

			&#x2F;&#x2F;PROGRESS
			var progress_raw = _this.get(item.id, &quot;progress&quot;, &#x27;raw&#x27;);
			var progress = _this.get(item.id, &quot;progress&quot;);

			if (!options.onlychanged) obj[&quot;progress&quot;] = progress;
			else
				if(!_.isUndefined(progress_raw) &amp;&amp; progress_raw!=&#x27;none&#x27; &amp;&amp; progress_raw!=&#x27;auto&#x27;)
					if(progress!=progress_raw  &amp;&amp; progress&gt;0)
						obj[&quot;progress&quot;] = progress;

			&#x2F;&#x2F;SCORE
			var score_raw = _this.get(item.id, &quot;score&quot;, &#x27;raw&#x27;);
			var score = _this.get(item.id, &quot;score&quot;,&#x27;string&#x27;);

			if (!options.onlychanged) obj[&quot;score&quot;] = score;
			else
				if(!_.isUndefined(score_raw) &amp;&amp; score_raw!=&#x27;none&#x27; &amp;&amp; score_raw!=&#x27;auto&#x27;)
					if(score!=score_raw)
						obj[&quot;score&quot;] = score;

			&#x2F;&#x2F;STATUS
			var status_raw = _this.get(item.id, &quot;status&quot;, &#x27;raw&#x27;);
			var status = _this.get(item.id, &quot;status&quot;);

			if (!options.onlychanged) obj[&quot;status&quot;] = status;
			else
				if(!_.isUndefined(status_raw) &amp;&amp; status_raw!=&#x27;none&#x27; &amp;&amp; status_raw!=&#x27;auto&#x27;)
					if(status&gt;0 &amp;&amp; status!=status_raw)
						obj[&quot;status&quot;] = status;


			&#x2F;&#x2F;add obj to json
			if (!options.onlychanged) myJSON.push(obj);
			else
				if (_.size(obj)&gt;1) myJSON.push(obj);


		});

		&#x2F;&#x2F;process return value
		if (options.format == &#x27;text&#x27;) myJSON = JSON.stringify(myJSON);

		return myJSON;


	};

	TrackManager.prototype.toJSONString = function (){

		var myJSON = this.toJSON();
		return JSON.stringify(myJSON);
	};

	TrackManager.prototype.setJSON = function (myJSON){
		
		&#x2F;&#x2F;no input param?
		if (!myJSON) return;

		&#x2F;&#x2F;process input param into data object
		var data = null;

		try{
			if (typeof myJSON == &#x27;string&#x27; &amp;&amp; myJSON!=&#x27;&#x27;){
				data = eval( &#x27;(&#x27;+ myJSON +&#x27;)&#x27; );
			}
			else{
				data = myJSON;
			}
		}
		catch(e){}

		&#x2F;&#x2F;no valid data?
		if (!data) return;


		var len = _.size(data);
		for (var i=len-1; i&gt;0;i--){
			&#x2F;&#x2F;try apply processed data
			try{

				var item = data[i];

				var track = this.collection.get(item.id);

				
				if (item.access) 	track.set(&#x27;access&#x27;, item.access, {&#x27;silent&#x27;:true});
				if (item.views) 	track.set(&#x27;views&#x27;, item.views, {&#x27;silent&#x27;:true});
				if (item.progress) 	track.set(&#x27;progress&#x27;, item.progress, {&#x27;silent&#x27;:true});
				if (item.score) 	track.set(&#x27;score&#x27;, item.score, {&#x27;silent&#x27;:true});
				if (item.status) 	track.set(&#x27;status&#x27;, item.status, {&#x27;silent&#x27;:true});
				

				console.log(&#x27;RESTORE :&#x27; + item.id);

			}
			catch(e){
				return e;
			}

		}



	};



	&#x2F;&#x2F;expose
	smx.tracking.TrackManager = TrackManager;


})(window.smx);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
