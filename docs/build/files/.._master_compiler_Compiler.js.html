<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..\master\compiler\Compiler.js - The Foo API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title="The Foo API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.2.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Metadata.html">Metadata</a></li>
            
                <li><a href="..&#x2F;classes/Playhead.html">Playhead</a></li>
            
                <li><a href="..&#x2F;classes/Timeline.html">Timeline</a></li>
            
                <li><a href="..&#x2F;classes/Timer.html">Timer</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/Node.html">Node</a></li>
            
                <li><a href="..&#x2F;modules/smx.html">smx</a></li>
            
                <li><a href="..&#x2F;modules/SMXComputedAttributes.html">SMXComputedAttributes</a></li>
            
                <li><a href="..&#x2F;modules/SMXCoreAttributes.html">SMXCoreAttributes</a></li>
            
                <li><a href="..&#x2F;modules/SMXNode.html">SMXNode</a></li>
            
                <li><a href="..&#x2F;modules/TimeAttrController
Plugin Controller for attributes namespace with &#x27;ui&#x27;.html">TimeAttrController
Plugin Controller for attributes namespace with &#x27;ui&#x27;</a></li>
            
                <li><a href="..&#x2F;modules/Track Attributes.html">Track Attributes</a></li>
            
                <li><a href="..&#x2F;modules/UIAttrController
Plugin Controller for attributes namespaced with &#x27;ui-&#x27;.html">UIAttrController
Plugin Controller for attributes namespaced with &#x27;ui-&#x27;</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ..\master\compiler\Compiler.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * SMX DOCUMENT COMPILER
 * Load smx xml document, search and load recursively &quot;include&quot; nodes
 *&#x2F;

(function(window,_,$,smx){



	&#x2F;**
	 *	Element definitions are flexible, but there some reserved tagnames
	 *	&lt;smx&gt;		root of any smx document
	 *	&lt;head&gt;		smx definitions container
	 *	&lt;body&gt;		smx content container
	 *	&lt;include&gt;	include another smx document
	 *	
	 *&#x2F;

	var SMX_ELEMENTS = {

		&#x27;smx&#x27;:{},

		&#x27;head&#x27;:{},

		&#x27;body&#x27;:{},

		&#x27;proto&#x27;:{},

		&#x27;include&#x27;:{}

	};

	var SMX_ATTRIBUTES = {

		&#x27;id&#x27;:{},

		&#x27;path&#x27;:{}, &#x27;file&#x27;:{}, &#x27;src&#x27;:{},	

		&#x27;meta&#x27;:{}, &#x27;track&#x27;:{}, &#x27;ui&#x27;:{}

	};



 	var DocumentCompiler = function(options){


		&#x2F;&#x2F;extended with custom events
		_.extend(this, Backbone.Events);

		&#x2F;&#x2F;define default options
		this.defaults = {
			&quot;path&quot; : &quot;&quot;,
			&quot;directoryIndex&quot; : &quot;index.xml&quot;,
			&quot;compiled&quot; : false
		};

		&#x2F;&#x2F; process options
		this.options = _.defaults(options || {}, this.defaults);

		&#x2F;&#x2F; XML Dcoument Object
		this.XML = null;

		&#x2F;&#x2F; TEXT XML code String (compressed &amp; factorized)
		this.TEXT = null;

		&#x2F;&#x2F; Ajax controller for file requests
		this.AjaxRequest = null;

		this.loadDocument = function(path){

			this.options.path = path || &#x27;&#x27;;


			if (this.options.compiled){
				var url = (this.options.path!=&#x27;&#x27;)? this.options.path+&#x27;&#x2F;&#x27;+ &#x27;index.txt&#x27; : &#x27;index.txt&#x27;;
				this.loadCompiledFile( url );	
			}
			else{
				var url = (this.options.path!=&#x27;&#x27;)? this.options.path+&#x27;&#x2F;&#x27;+ this.options.directoryIndex : &#x27;&#x27;+this.options.directoryIndex;
				this.loadXMLFile( url );				
			}

			
			return;

		};

		this.loadXMLFile = function(file){
		
			&#x2F;&#x2F;filter params
			if(!file) this.onLoadXMLError(&#x27;ERROR: loadXMLFile -&gt; no file&#x27;);

			console.log(&#x27;@ LOADING XML &#x27;+ file +&#x27;&#x27;);
			
			this.AjaxRequest = $.ajax({
				&#x27;type&#x27;: &quot;GET&quot;,
				&#x27;url&#x27;: file,
				&#x27;dataType&#x27;: &quot;xml&quot;,
				&#x27;cache&#x27;: false,
				&#x27;data&#x27;:&#x27;&#x27;,
				&#x27;success&#x27;: _.bind(this.onLoadXMLSuccess, this),
				&#x27;error&#x27;: _.bind(this.onLoadXMLError, this)
	 		});

	 		this.AjaxRequest.url = file;

	 		return;

		};

		this.onLoadXMLSuccess = function(xml){

			var url = this.AjaxRequest.url;
			&#x2F;&#x2F;debug.log(&#x27;OK &quot;&#x27;+ url +&#x27;&quot; loaded!&#x27;);

			&#x2F;&#x2F;detect if already exist xml root node
			var is_root = (!this.XML)? true : false;

			if (is_root){

				&#x2F;&#x2F;set xml root node
				this.XML = $(xml)[0];	

			}
			else{

				&#x2F;&#x2F;if is not root -&gt; is an include
				&#x2F;&#x2F;replaces 1st &lt;include&gt; found with just loaded xml

				var includes = $(this.XML).find(&#x27;include&#x27;);

				&#x2F;&#x2F;get &lt;include&gt; node
				var old_node = includes[0];

				&#x2F;&#x2F;get just loaded node
				var new_node = xml.lastChild;

				&#x2F;&#x2F;copy old_node attributes into new_node 
				$(new_node).attr(&#x27;id&#x27;, $(old_node).attr(&#x27;id&#x27;));

				&#x2F;&#x2F;create &#x27;path&#x27; and &#x27;file&#x27; from &#x27;src&#x27;
				var src_attr = $(old_node).attr(&#x27;src&#x27;);
				if (src_attr){

					var path_attr = &#x27;&#x27;;
					var file_attr = &#x27;&#x27;;

					var src_parts = src_attr.split(&#x27;&#x2F;&#x27;);
					if(src_parts.length&gt;0){
						if(src_parts[src_parts.length-1].indexOf(&#x27;.xml&#x27;)){
							file_attr = src_parts[src_parts.length-1];
							src_parts.pop();
							path_attr = src_parts.join(&#x27;&#x2F;&#x27;);
						}
						else{
							path_attr = src_attr;
						}
					}
							
					&#x2F;&#x2F;set inlcuded node core attributes
					if(!_.isEmpty(path_attr)) $(new_node).attr(&#x27;path&#x27;, path_attr);
					if(!_.isEmpty(file_attr)) $(new_node).attr(&#x27;file&#x27;, file_attr);

				}

				&#x2F;&#x2F;copy old node attributes into new node
				var old_attributes = old_node.attributes;
				var no_copy_attributes = [&#x27;id&#x27;,&#x27;src&#x27;,&#x27;path&#x27;,&#x27;file&#x27;];
				for (var i=0; i&lt; old_attributes.length; i++){
					var attr_name = old_attributes[i].name;
					var attr_value = old_attributes[i].value;

					if(!_.contains(no_copy_attributes, attr_name)){
						var attr = $(new_node).attr(attr_name);
						if(typeof attr !== &#x27;undefined&#x27; &amp;&amp; attr !== false){
							&#x2F;&#x2F;new node has its own attribute value
						}
						else{
							&#x2F;&#x2F;copy attribute 
							$(new_node).attr(attr_name, attr_value);	
						}
						
					}
				}				


				&#x2F;&#x2F;replace old node with new node
				$(old_node).replaceWith(new_node);

			}


			&#x2F;&#x2F;check for &lt;include&gt;?
			var includes = $(this.XML).find(&#x27;include&#x27;);
			if(includes.length&gt;0){

				var include_path = $(includes[0]).attr(&#x27;src&#x27;) || &#x27;&#x27;;
				var ref = includes[0];
				while (ref.parentNode){
					var parent = ref.parentNode;
					if ($(parent).attr(&#x27;path&#x27;)) include_path = $(parent).attr(&#x27;path&#x27;) + &#x27;&#x2F;&#x27; + include_path;
					ref = parent;
				}

				if (include_path &amp;&amp; include_path!= &#x27;&#x27;) this.loadXMLFile(this.options.path+&#x27;&#x2F;&#x27;+include_path);

				return;
			}

			&#x2F;&#x2F; get server date for date synchronized behaviors
			&#x2F;&#x2F; client date can be hacked easily
			&#x2F;&#x2F; rely only on server date instead client date
			&#x2F;&#x2F; this.serverDate = arguments[2].getResponseHeader(&#x27;date&#x27;);


			this.onLoadXMLComplete();

			return;

		};

		this.onLoadXMLError = function(e){

			var url = this.AjaxRequest.url;
			&#x2F;&#x2F;debug.log(&#x27;ERROR loading &quot;&#x27;+ url +&#x27;&quot;&#x27;);

			this.trigger(&#x27;error&#x27;);
		};

		this.onLoadXMLComplete = function(){

			try{ this.factorizeXML() }
			catch(e){
				LOG(&#x27;COMPILER: ERROR! factorizeXML failed!&#x27;)
			}

			try{ this.compressXML() }
			catch(e){
				LOG(&#x27;COMPILER: ERROR! compressXML failed!&#x27;)
			}
			

			this.trigger(&#x27;complete&#x27;, this.XML);

		};



		this.loadCompiledFile = function(file){
		
			&#x2F;&#x2F;filter params
			if(!file) this.onLoadXMLError(&#x27;ERROR: loadXMLFile -&gt; no file&#x27;);

			console.log(&#x27;@ LOADING COMPILED &#x27;+ file +&#x27;&#x27;);
			
			this.AjaxRequest = $.ajax({
				&#x27;type&#x27;: &quot;GET&quot;,
				&#x27;url&#x27;: file,
				&#x27;dataType&#x27;: &quot;text&quot;,
				&#x27;async&#x27;: false,
				&#x27;cache&#x27;: false,
				&#x27;data&#x27;:&#x27;&#x27;,
				&#x27;success&#x27;: _.bind(this.onLoadCompiledSuccess, this),
				&#x27;error&#x27;: _.bind(this.onLoadCompiledError, this)
	 		});

	 		this.AjaxRequest.url = file;

	 		return;

		};

		this.onLoadCompiledSuccess = function(text){

			this.TEXT = this.decryptText(text);

			&#x2F;&#x2F;set xml root node
			this.XML = this.str2XML(this.TEXT);

			this.trigger(&#x27;complete&#x27;, this.XML);

			return;

		};

		this.onLoadCompiledError = function(e){

			var url = this.AjaxRequest.url;
			&#x2F;&#x2F;debug.log(&#x27;ERROR loading &quot;&#x27;+ url +&#x27;&quot;&#x27;);

			this.trigger(&#x27;error&#x27;);
		};



		this.factorizeXML = function(){

	
			&#x2F;&#x2F;remove undesired content, xml comments and others
			$(this.XML).find(&#x27;*&#x27;).each(function(index,item) {
			    if(item.nodeType != 1) {
			        $(item).remove();
			    }
			});
			

			&#x2F;&#x2F;ensure all xml nodes have an id attribute
			&#x2F;&#x2F;var getUTId = function(){ var time = new Date().getTime(); while (time == new Date().getTime()); return new Date().getTime()+&#x27;&#x27;; };
			var nid = 0; var getUTId = function(){ nid=nid+1; return &#x27;&#x27;+nid };
			$(this.XML).find(&#x27;:not([id])&#x27;).each(_.bind(function(index,item){
				$(item).attr(&#x27;id&#x27;,getUTId());
			},this));


			&#x2F;&#x2F;check for duplicated ids
			$(this.XML).find(&#x27;[id]&#x27;).each(_.bind(function(index,item){
				var id = $(item).attr(&#x27;id&#x27;);
				var ids = $(this.XML).find(&#x27;[id=&quot;&#x27;+id+&#x27;&quot;]&#x27;);
				if(ids.length&gt;1 &amp;&amp; ids[0]==this)
				console.warn(&#x27;Multiple IDs #&#x27;+id);
			},this));




			&#x2F;&#x2F;normalize all attributes refering time values
			var parseTime = function(value, default_value){

				if ( !value || !_.isString(value) || value == &#x27;auto&#x27; || value&lt;0 )
					return default_value;

				var important = false;
				if(value.indexOf(&#x27;!&#x27;)==0){
					important = true;
					value = value.substr(1);
				}

				if (value.indexOf(&#x27;:&#x27;)&gt;=0){
					
					var sum = 0;
					var factor = 1;
					var values=(value).split(&#x27;:&#x27;);
					values.reverse();
					for (var i = 0; i&lt;values.length; i++){
						sum += parseFloat(values[i])*factor;
						factor = factor*60;
					}

					if (important) 	return &#x27;!&#x27;+sum;
					else 			return sum;
				}

				if (important) 	return &#x27;!&#x27;+parseFloat(value);
				else 			return parseFloat(value);

			};

			$(this.XML).find(&#x27;[duration],[start],[offset]&#x27;).each(_.bind(function(index,item){

				var duration = $(item).attr(&#x27;duration&#x27;);
				var start = $(item).attr(&#x27;start&#x27;);
				var offset = $(item).attr(&#x27;offset&#x27;);

				if (duration) $(item).attr(&#x27;duration&#x27;,parseTime(duration,&#x27;auto&#x27;));
				if (start) $(item).attr(&#x27;start&#x27;,parseTime(start,&#x27;auto&#x27;));
				if (offset) $(item).attr(&#x27;offset&#x27;,parseTime(offset,0));

			},this));


			return;
		};




		this.compressXML = function(){


			&#x2F;&#x2F;get serialized xml code
			var code = this.XML2str(this.XML);


			&#x2F;&#x2F;remove multiple whitespaces
			var min = code.replace(&#x2F;\s+&#x2F;gm,&quot; &quot;);


			&#x2F;&#x2F;remove newline &#x2F; carriage return
			min = min.replace(&#x2F;\n&#x2F;g, &quot;&quot;);

			&#x2F;&#x2F;remove whitespace (space and tabs) before tags
			min = min.replace(&#x2F;[\t ]+\&lt;&#x2F;gm, &quot;&lt;&quot;);

			&#x2F;&#x2F;remove whitespace between tags
			min = min.replace(&#x2F;\&gt;[\t ]+\&lt;&#x2F;gm, &quot;&gt;&lt;&quot;);

			&#x2F;&#x2F;remove whitespace after tags
			min = min.replace(&#x2F;\&gt;[\t ]+$&#x2F;gm, &quot;&gt;&quot;);


			&#x2F;&#x2F;remove XML comments
			min = min.replace(&#x2F;&lt;!--(.*?)--&gt;&#x2F;gm, &quot;&quot;);

			&#x2F;&#x2F;update compiler TEXT result
			this.TEXT = min;



			&#x2F;&#x2F;update compiler xml result
			this.XML = this.str2XML(min);

			return;
		};


		this.XML2str = function(XML){

			var str = &#x27;&#x27;;

			if (window.ActiveXObject){

				if (XML.xml) str = XML.xml;
				else{
					str = (new XMLSerializer()).serializeToString(XML);
				}

			}
			else{
				str = (new XMLSerializer()).serializeToString(XML);
			}





			&#x2F;*
			if(window.ActiveXObject){
				alert(&#x27;window.ActiveXObject: &#x27; + window.ActiveXObject)
			}
			alert(&#x27;XML.xml: &#x27; +XML.xml);
			*&#x2F;

			&#x2F;&#x2F;alert(str);

			return str;	

		};

		this.str2XML = function(str){

			var XML = null;

            if (window.ActiveXObject){

              var XML = new ActiveXObject(&#x27;Microsoft.XMLDOM&#x27;);
              XML.async = &#x27;false&#x27;;
              XML.loadXML(str);

            } else {

              var parser = new DOMParser();
              var XML = parser.parseFromString(str,&#x27;text&#x2F;xml&#x27;);

            }

            return XML;
		};


		&#x2F;*
			raw copy from:
			http:&#x2F;&#x2F;davidwalsh.name&#x2F;convert-xml-json

		*&#x2F;
		this.xmlToJson = function(xml) {
			
			&#x2F;&#x2F; Create the return object
			var obj = {};

			if (xml.nodeType == 1) { &#x2F;&#x2F; element
				&#x2F;&#x2F; do attributes
				if (xml.attributes.length &gt; 0) {
				obj[&quot;@attributes&quot;] = {};
					for (var j = 0; j &lt; xml.attributes.length; j++) {
						var attribute = xml.attributes.item(j);
						obj[&quot;@attributes&quot;][attribute.nodeName] = attribute.nodeValue;
					}
				}
			} else if (xml.nodeType == 3) { &#x2F;&#x2F; text
				obj = xml.nodeValue;
			}

			&#x2F;&#x2F; do children
			if (xml.hasChildNodes()) {
				for(var i = 0; i &lt; xml.childNodes.length; i++) {
					var item = xml.childNodes.item(i);
					var nodeName = item.nodeName;
					if (typeof(obj[nodeName]) == &quot;undefined&quot;) {
						obj[nodeName] = this.xmlToJson(item);
					} else {
						if (typeof(obj[nodeName].push) == &quot;undefined&quot;) {
							var old = obj[nodeName];
							obj[nodeName] = [];
							obj[nodeName].push(old);
						}
						obj[nodeName].push(this.xmlToJson(item));
					}
				}
			}
			return obj;

		};


		this.encryptText = function(TEXT){

			if (!_.isString(TEXT)) return;

			var encrypted = &#x27;&#x27;;

			for (var c=0; c&lt; TEXT.length;c++){
				&#x2F;&#x2F;var offset = (c%99);
				var offset = 1;
				encrypted+= String.fromCharCode(TEXT.charCodeAt(c)+offset);
			}

			return encrypted;
		};

		this.decryptText = function(TEXT){

			if (!_.isString(TEXT)) return;

			var decrypted = &#x27;&#x27;;

			for (var c=0; c&lt; TEXT.length;c++){
				&#x2F;&#x2F;var offset = (c%99);
				var offset = 1;
				decrypted+= String.fromCharCode(TEXT.charCodeAt(c)-offset);
			}

			return decrypted;
		};

		return this;
		
	
	};


	&#x2F;&#x2F;expose
	smx.Compiler = DocumentCompiler;




})(window,_,$,smx);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
